# 输入输出设备
## IO控制方式
### 程序直接控制

这是主机与外设间进行信息交换的最简单的方式，输入和输出完全是通过CPU执行程序来完成的。

一旦某一外设被选中并启动后，主机将查询这个外设的某些状态位，看其是否准备就绪？若外设未准备就绪，主机将再次查询；若外设已准备就绪，则执行一次I/O操作（一个字节）。

### 中断控制

- 在主机启动外设后，无须等待查询，而是继续执行原来的程序；
- 外设在做好输入输出准备时，向主机发中断请求；
- 主机接到请求后就暂时中止原来执行的程序，转去执行中断服务程序对外部请求进行处理；
- CPU检查完成状态，若出错则进行出错处理；
- 否则从I/O控制器中读出“字”并向内存中写入“字”
- 在中断处理完毕后返回原来的程序继续执行。

- 显然，程序中断不仅适用于外部设备的输入输出操作，也适用于对外界发生的随机事件的处理。
- 完成一次程序中断还需要许多辅助操作，主要适用于中、低速外设。

#### 外中断
- 指来自处理机和内存外部的中断。包括I/O设备发出的I/O中断、外部信号中断（例如按ESC键）、时钟中断、调试程序中的断点引起的调试中断。
- 外中断在狭义上一般称为中断

#### 内中断:又称陷阱trap
- 来自于处理机和内存内部的中断
- 包括运算引起的各种错误，如地址非法、校验错、页面失效、存取访问控制错、算术操作溢出、数据格式非法、除数为零、非法指令、用户程序执行特权指令、时间片中断、用户态到核心态的切换陷阱等

### DMA

- 外设可通过DMA控制器向CPU发出DMA请求：
- CPU响应DMA请求，把总线控制权交给DMA控制器；
- 由DMA控制器发送存储器地址，并决定传送数据块的长度；
- 执行DMA传送；
- DMA操作结束，并把总线控制权交还CPU。

### IO通道

- 在用户程序中使用访管指令进入管理程序，由CPU通过管理程序组织一个通道程序，并启动通道。
- 通道执行CPU为它组织的通道程序，完成指定的数据输入输出工作。
- 通道程序结束后向CPU发中断请求。CPU响应这个中断请求后，第二次进入操作系统，调用管理程序对中断请求进行处理。

### 优缺点
1. 程序直接控制方式
- 缺点：
    - CPU和IO设备之间只能串行工作
    - CPU在同一段时间内只能和一台外设交互，无法实现设备间的并行工作
    - 无法发现由设备和其他硬件所产生的错误
2. 中断控制方式
- 优点：
    - 解决了主机和外设并行工作的问题；尤其是慢的外设
    - 能充分发挥处理器的使用效率；CPU不用无限查询等待
    - 提高系统的实时能力
- 缺点
    - 中断驱动I/O是以字节为单位进行I/O的，每完成一个字节的I/O，控制器便要向CPU请求一次中断。若从磁盘读出1KB的数据块，需要中断1K次CPU
3. DMA控制方式
- 优点：
    - 数据传输的基本单位是数据块，即CPU与I/O设备之间，每次传送至少是一个数据块
    - 所传送的数据是从设备直接送入内存的，或者相反；不需CPU
    - 仅在传送一个或多个数据块的开始或结束时，才需CPU干预，整块数据的传送是在DMA控制器的控制下完成的。
- 缺点：
    - DMA方式对外围设备的管理和某些操作仍由CPU控制，当外设种类数量较多时，控制也很复杂；
    - 多个DMA控制器的同时使用会引起内存地址的冲突，并使控制过程进一步复杂化。
    - 多个DMA同时使用也不经济。
4. I/O通道控制方式
- 优点：
    - 在DMA方式中，数据的传送方向、存放数据的内存始址以及传送数据块长度等由CPU控制；在通道方式下，上述操作都由专管输入、输出的硬件-通道来进行控制
    - 通道控制方式可以做到一个通道控制多台设备与内存进行数据交换，这与DMA方式时每台设备至少有一个DMA控制器不同。

## I/O系统的层次

|IO请求的下一级|层次|IO应答的下一级|IO功能|
|---|---|---|---|
| 与设备无关的软件 | 用户进程 | - | 产生IO请求；对IO进行格式化；假脱机 |
| 设备驱动程序 | 与设备无关的软件 | 用户进程 | 命名、保护、分块、缓冲、分配 |
| 硬件 | 设备驱动程序 | 与设备无关的软件 | 设置设备寄存器；检查状态 |
| - | 中断处理程序 | 设备驱动程序 | 当IO完成时唤醒驱动程序 |
| - | 硬件 | 中断处理程序 | 执行IO操作 |



